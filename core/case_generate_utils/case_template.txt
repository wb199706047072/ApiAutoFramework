# -*- coding: utf-8 -*-
# @Time    : ${DATE} ${TIME}
# @Author  : ä¼šé£çš„ğŸŸ
# @File    : ${NAME}.py
# @Software: ${PRODUCT_NAME}
# @Desc: 

import pytest
import allure
from loguru import logger
from config.settings import GLOBAL_VARS
from core.requests_utils.request_control import RequestControl
from core.requests_utils.case_dependence import CaseDependenceHandler
# å…¬å…±ä¾èµ–
dependence_handler = CaseDependenceHandler(GLOBAL_VARS)

# ç”¨ä¾‹æ•°æ®
cases = ${case_data}
@allure.epic("${epic}")
@allure.feature("${feature}")
@allure.story("${story}")
@pytest.mark.auto
${markers}
@pytest.mark.parametrize("case", cases, ids=lambda x: x["title"])
def ${func_title}_auto(case):
    # å‰ç½®ä¾èµ–å¤„ç†
    if case.get("case_dependence") and case["case_dependence"].get("setup"):
        dependence_results = dependence_handler.case_dependence_handle(
            case_dependence=case["case_dependence"]["setup"],
            db_info=GLOBAL_VARS["db_info"])
        GLOBAL_VARS.update(dependence_results if dependence_results else {})
    # å¤„ç†è¯·æ±‚å‰çš„ç”¨ä¾‹æ•°æ® -> å‘é€è¯·æ±‚ -> å“åº”/æ•°æ®åº“æ–­è¨€ -> æ–­è¨€æˆåŠŸåè¿›è¡Œå‚æ•°æå–
    if GLOBAL_VARS.get("db_info"):
        res = RequestControl().api_request_flow(request_data=case, global_var=GLOBAL_VARS, db_info=GLOBAL_VARS["db_info"])
    else:
        res = RequestControl().api_request_flow(request_data=case, global_var=GLOBAL_VARS)
    GLOBAL_VARS.update(res)
    # åç½®ä¾èµ–å¤„ç†
    if case.get("case_dependence") and case["case_dependence"].get("teardown"):
        dependence_results = dependence_handler.case_dependence_handle(
            case_dependence=case["case_dependence"]["teardown"],
            db_info=GLOBAL_VARS["db_info"])
        GLOBAL_VARS.update(dependence_results if dependence_results else {})
